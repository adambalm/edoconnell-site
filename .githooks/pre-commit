#!/bin/bash
# Pre-commit hook: warn if architectural files changed without doc updates.
# Checks three public-facing docs: CLAUDE.md, AGENTS.md, README.md
# Non-blocking — warns, does not prevent commit.

ARCH_PATTERNS=(
  "astro.config"
  "package.json"
  "tsconfig.json"
  "sanity.config"
  "sanity.cli"
  "src/sanity/schemas/"
  "src/layouts/"
  "src/lib/"
  "src/content/"
  ".claude/"
  "vercel.json"
)

DOC_FILES=("CLAUDE.md" "AGENTS.md" "README.md")

staged_files=$(git diff --cached --name-only 2>/dev/null)
if [ -z "$staged_files" ]; then
  exit 0
fi

# Check if any architectural file is staged
arch_changed=false
matched_files=""
for pattern in "${ARCH_PATTERNS[@]}"; do
  matches=$(echo "$staged_files" | grep "$pattern" || true)
  if [ -n "$matches" ]; then
    arch_changed=true
    matched_files="$matched_files$matches"$'\n'
  fi
done

if [ "$arch_changed" = false ]; then
  exit 0
fi

# Check which doc files were NOT updated
stale_docs=""
for doc in "${DOC_FILES[@]}"; do
  if ! echo "$staged_files" | grep -q "$doc"; then
    if [ -f "$doc" ]; then
      stale_docs="$stale_docs  $doc"$'\n'
    fi
  fi
done

if [ -n "$stale_docs" ]; then
  echo ""
  echo "  Architectural files changed:"
  echo "$matched_files" | sed '/^$/d' | sed 's/^/     /'
  echo ""
  echo "  These docs were not updated:"
  echo "$stale_docs" | sed '/^$/d'
  echo ""
  echo "  Not every change requires a doc update — but check."
  echo "  (Warning only — commit proceeds.)"
  echo ""
fi

exit 0
